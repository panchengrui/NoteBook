# 问题描述

​	导入进度卡在80%

​	bug issue: http://git.sn.int/healthcare/qingdao/ms-cohort/issues/300

# 产生原因

​	同一个账户同时上传多个文件，某个先完成的任务，触发删除临时数据库中该用户所有上传的数据，导致其他的正在进行的任务数据丢失，数据转移无法继续进行，进度卡在了80%

# 初步设想的解决方法

## 1.task状态数字说明

```java
	TASK_CREATE(0, "任务创建"),
    SHEET_HEAD_CHECK_ERROR(1, "模板错误，表头有误"),
    SHEET_HEAD_CHECK_FINISH(2, "完成模板检查"),
    SHEET_HAS_HISTORY(3, "完成历史数据检查，有历史数据"),
    SHEET_NOT_HAS_HISTORY(4, "完成历史数据检查，没有历史数据"),
    SHEET_ANALYSIS_DOING(5, "任务进行中"),
    SHEET_TRANSFER_FINISH(6, "任务完成"),
    SHEET_TRANSFER_FINISH_NO_VALID_DATA(7, "任务完成，没有有效数据");
```

## 2.对task表中status字段所有变化过程的说明

* 终止状态：最后一位数字代表数据库中status字段最终可能停留的状态，该字段不会再被改变

  | 序号 | 终止状态                  | 说明                                                         |
  | ---- | ------------------------- | ------------------------------------------------------------ |
  | 1    | ==0==                     | 用户点了"导入文件->选择文件"，没有点击"确认导入"，并且关闭了对话框 |
  | 2    | 0    **1**                | 用户进行了上述操作，点击了"确认导入"，程序进行模板检查，发现有误 |
  | 3    | 0    ==2==                | 用户进行了上述操作，模板检查完毕，模板正确，历史数据检查尚未完成，这时程序异常退出 |
  | 4    | 0    2    ==3==           | 用户进行了上述操作，模板检查通过，完成了模板检查，发现有历史数据，但是用户没有点击"追加"或"替换"，而是关闭了对话框 |
  | 5    | 0    2    3    ==5==      | 数据在解析或者转移，但由于服务中断或消息队列异常，导致程序卡在执行中的状态 |
  | 6    | 0    2    3    5    **6** | 所有的过程正常运行，完成了数据的转移                         |
  | 7    | 0    2    5    **7**      | 所有的过程正常运行，只不过没有有效数据，也视为完成了数据的转移 |

* 中间状态：表示最后一位数字可能仅仅是同一账号两次操作中间稍作停留的状态，该字段后续还会再改变

  ​	讨论的情景是同一个账户，同时进行的两次任务A和B

  |      | 中间状态        | 说明                                                         |
  | ---- | --------------- | ------------------------------------------------------------ |
  | 1    | ==0==           | A刚执行完文件上传，模板检查还没有完成，这时B也执行了上传     |
  | 2    | 0    ==2==      | A完成了模板检查，但是还没有完成历史数据的检查，这时B执行了上传和模板检查 |
  | 3    | 0    2    ==3== | A完成了模板检查和历史数据的检查，在弹出框中没有点击"追加"或"替换"，这时B执行了操作 |
  | 4    | 0    2    ==5== | A正在执行任务解析或数据转移，这时B执行了上传导入等一系列操作 |

## 3.解决思路

​	只有1、6、7的状态是完全的终止状态，状态不会再改变，而0、2、3、5同时存在于两种状态中，如果一个任务的status字段是0或2或3或5，那么无法判断该任务是已经终止了，还是正在执行中，并且0、2、3、5的中间状态是无法避免的，所以在程序执行过程中，如果该账号下存在其他的任务处于中间状态，应该拒绝新的任务（<u>程序正常执行情况下</u>）；或者弹出提示框，提示用户对0、2、3、5状态的任务进行操作（<u>手动关闭操作框或异常导致</u>）。



### 需要前端配合的方案：

​	后端需要对**文件上传接口**、**导入接口**和**确认导入接口**三个接口中加上对当前用户下所有task表中status字段的判断，<u>如果查询到当前用户下有存在status为0、2、3、5的任务，每个接口应当做相应的操作来拒绝新的任务</u>

| 接口         | 状态      | 操作                                                         |
| ------------ | --------- | ------------------------------------------------------------ |
| 文件上传接口 | 0         | 禁止上传文件，返回“您有未完成的历史任务”，将task信息以列表形式返回，前端弹出提示框，提示用户对未完成的任务进行后续操作（继续或废弃，如果选择废弃，将status状态改为8） |
|              | 2         | 同上                                                         |
|              | 3         | 同上                                                         |
|              | 5         | 前台不显示文件上传按钮，直接显示进度                         |
|              |           |                                                              |
| **接口**     | **状态**  | **操作**                                                     |
| 导入接口     | 0（正常） | 查询是不是只有当前任务的status为0，如果只有当前任务status为0，则正常执行后续的操作；如果还有其他任务的status为0，则禁止导入操作，返回“您有未完成的历史任务”，将task信息以列表形式返回，前端弹出提示框，提示用户对未完成的任务进行后续操作（继续或废弃，如果选择废弃，将status状态改为8） |
|              | 2         | 禁止导入文件，返回“您有未完成的历史任务”，将task信息以列表形式返回，前端弹出提示框，提示用户对未完成的任务进行后续操作（继续或废弃，如果选择废弃，将status状态改为8） |
|              | 3         | 和status为2相同的处理方法                                    |
|              | 5         | 前台不显示文件上传按钮，直接显示进度                         |
|              |           |                                                              |
| **接口**     | **状态**  | **操作**                                                     |
| 确认导入接口 | 0         | 禁止确认导入操作，返回“您有未完成的历史任务”，将task信息以列表形式返回，前端弹出提示框，提示用户对未完成的任务进行后续操作（继续或废弃，如果选择废弃，将status状态改为8） |
|              | 2         | 和status为0相同的处理方法                                    |
|              | 3（正常） | 查询是不是只有当前任务的status为3，如果只有当前任务status为3，则正常执行后续的操作；如果还有其他任务的status为3，则禁止确认导入操作，返回“您有未完成的历史任务”，将task信息以列表形式返回，前端弹出提示框，提示用户对未完成的任务进行后续操作（继续或废弃，如果选择废弃，将status状态改为8） |
|              | 5         | 前台不显示文件上传按钮，直接显示进度                         |



### 后端解决方案：

三个接口，在调用前，先对之前的ststus为0、2、3、4的任务做一次覆盖，将它们全部置为8的终止状态（根据league、org、userId），如果有status为5的任务，直接拒绝新的任务

| 接口         | 状态      | 操作                                          |
| ------------ | --------- | --------------------------------------------- |
| 文件上传接口 | 0         | 将所有状态为0的其他任务改为8，终止操作        |
|              | 2         | 将所有状态为2的其他任务改为8，终止操作        |
|              | 3         | 将所有状态为3的其他任务改为8，终止操作        |
|              | 5         | 直接拒绝新的任务                              |
|              |           |                                               |
| **接口**     | **状态**  | **操作**                                      |
| 导入接口     | 0（正常） | 将所有状态为0的<u>其他</u>任务改为8，终止操作 |
|              | 2         | 将所有状态为2的其他任务改为8，终止操作        |
|              | 3         | 将所有状态为3的其他任务改为8，终止操作        |
|              | 5         | 直接拒绝新的任务                              |
|              |           |                                               |
| **接口**     | **状态**  | **操作**                                      |
| 确认导入接口 | 0         | 将所有状态为0的<u>其他</u>任务改为8，终止操作 |
|              | 2         | 将所有状态为2的其他任务改为8，终止操作        |
|              | 3（正常） | 将所有状态为3的<u>其他</u>任务改为8，终止操作 |
|              | 5         | 直接拒绝新的任务                              |

​	之后在三个接口中，每次要修改当前任务的status为中间状态（2,3,4,5）前，先判断当前任务的状态是不是已经是终止状态（1,5,6,7,8，5视为终止状态，保证之前已经在进行解析的任务继续执行），如果是，则直接返回，终止操作